#!/usr/bin/env lua

require('extensions')
local u = require('utils')
local Repo = require('repo')
local c = require('colors')
local env = {}
env.home = os.getenv("HOME")

local parse_commands = function (arg)
  local a = u.make_dict(arg)
  local commands = {
    list   = a["list"]   or a["ls"],
    rescan = a["rescan"] or a["re"]
  }
  print('commands:')
  for k, v in pairs(commands) do
    print(k, v)
  end
  return commands
end


local scanlist = {
  '~/dots',
  '~/dots/personal',
  '~/dots/zsh',
  '~/repos/ags',
  '~/repos/books'
}

local git_repos = {}
local not_repos = {}
for _, k in pairs(scanlist) do
  local dir = k:gsub('^~', env.home)
  local g = dir .. '/.git'
  if u.exists(g) then
    table.insert(git_repos, dir)
  else
    table.insert(not_repos, dir)
  end
end

local repos = {}
for _, dir in pairs(git_repos) do
  local res = Repo.new(dir)
  if res then
    table.insert(repos, res)
  end
end


local main = function ()
  for _, r in pairs(repos) do
    local name = c.green(r.name)
    print('\n'..c.gray('[')..name..c.gray('/'..r.branch..']'))
    table.print(r.commits)
    table.print(r.status)
  end
  print()
end

parse_commands(arg)
-- main()
